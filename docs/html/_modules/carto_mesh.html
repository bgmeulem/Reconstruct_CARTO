<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2D2D2D" />
  
  <title>Reconstruct CARTO :: carto_mesh</title>
  

  <link rel="icon" type="image/png" sizes="32x32" href="../_static/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../_static/img/favicon-16x16.png">
  <link rel="index" title="Index" href="../genindex.html"/>

  <link rel="stylesheet" href="../_static/css/insegel.css"/>
  <link rel="stylesheet" href="../_static/css/custom.css"/>

  <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
  

  <script src="https://email.tl.fortawesome.com/c/eJxNjUEOgyAQAF8jR7Kw6wIHDh7sP1Cw2mgxgmn6-3JsMqc5zEQfE8dkxOY1KKMUOI3ACFKRJpSW2AAp7ontYIaxI6i7XPJVwyeVfCQ550Os3jLrGSNOLgbdAy6s0PBk2TFNjEbsfq31LB0OnX407pJa5v2faRadwSW63mn5KuLyR9j2tgx3zecanl-55R_-jjPs"></script> 
</head>

<body>
  <div id="insegel-container">
    <header>
      <div id="logo-container">
          
          <a href="../index.html"><img src="../_static/cv.png"></a>
          
      </div>
      <div id="project-container">
        
        <h1>Reconstruct CARTO Documentation</h1>
        
      </div>
    </header>

    <div id="content-container">

      <div id="main-content-container">
        <div id="main-content" role="main">
          
  <h1>Source code for carto_mesh</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file contains the class CartoMesh with all its reconstruction-specific methods.</span>
<span class="sd">This class contains methods for initialising from a .mesh file, plotting, reconstructing and applying conduction velocities.</span>
<span class="sd">This file imports :mod:`mesh_tools` for all general mesh functions that are not specific to carto meshes.</span>
<span class="sd">:mod:`mesh_tools` also concerns itself with all python module imports.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">mesh_tools</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="CartoMesh"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh">[docs]</a><span class="k">class</span> <span class="nc">CartoMesh</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class containing functions for initialising from file, plotting, reconstructing and</span>
<span class="sd">    applying conduction velocities.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_points</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">triangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_triangles</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triangle_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">myo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_myo</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialiseFromFile</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__readSettings</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__initialiseFromFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the class from either a .mesh file or a .vtk file.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The filename (.mesh or .vtk), or the directory containing the .mesh file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">parseName</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Given a filename to initialise, this method parses the filename and extracts the filetype and</span>
<span class="sd">             parent directory.</span>
<span class="sd">            Args:</span>
<span class="sd">                fn: Filename, containing extension or not, or name of the parent directory</span>

<span class="sd">            Returns:</span>
<span class="sd">                Tuple: tuple containing the name of the file and the name of its parent directory</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">fn</span><span class="p">:</span>  <span class="c1"># starred expression: file name not given</span>
                <span class="n">fn_</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># search for the file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn_</span> <span class="o">=</span> <span class="n">fn</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">fn_</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span> <span class="k">if</span> <span class="n">fn_</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;.mesh&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;.vtk&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># only directory given: look for file</span>
                <span class="n">fns</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="s1">&#39;*.mesh&#39;</span><span class="p">))</span>  <span class="c1"># take first .mesh file</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">):</span>
                    <span class="n">comp</span> <span class="o">=</span> <span class="n">fns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>  <span class="c1"># overwrite filename and dir components</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;No .mesh or .vtk file found in directory </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s2">&quot;</span>
                                            <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">comp</span><span class="p">)))</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">comp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
            <span class="n">n</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># drop file extension</span>
            <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span>

        <span class="k">def</span> <span class="nf">initialiseFromMeshFile</span><span class="p">(</span><span class="n">self_</span><span class="p">,</span> <span class="n">name_</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Initialize a carto mesh from .mesh file.</span>
<span class="sd">            Reads in a .mesh file and writes out a .csv file per .mesh header. Reads in the VerticesSection and</span>
<span class="sd">            TrianglesSection and uses these to construct a mesh.</span>

<span class="sd">            Args:</span>
<span class="sd">                self_: self, the :class:`CartoMesh` object, passed through from the overarching function.</span>

<span class="sd">                name_: name of .mesh file to be initialised, including &#39;.mesh&#39; extension</span>

<span class="sd">            Returns:</span>
<span class="sd">                None: Nothing. Updates mesh.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">self_</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">self_</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">parseName</span><span class="p">(</span><span class="n">name_</span><span class="p">)</span>
            <span class="n">self_</span><span class="o">.</span><span class="n">__cartoToCsv</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">vert</span><span class="p">,</span> <span class="n">tri</span> <span class="o">=</span> <span class="n">self_</span><span class="o">.</span><span class="n">__readVertTri</span><span class="p">()</span>
            <span class="n">self_</span><span class="o">.</span><span class="n">point_info</span> <span class="o">=</span> <span class="n">vert</span>
            <span class="n">self_</span><span class="o">.</span><span class="n">triangle_info</span> <span class="o">=</span> <span class="n">tri</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1000.</span> <span class="o">*</span> <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)]</span>
                               <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">self_</span><span class="o">.</span><span class="n">point_info</span><span class="p">[[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
            <span class="n">triangles</span> <span class="o">=</span> <span class="n">self_</span><span class="o">.</span><span class="n">triangle_info</span><span class="p">[[</span><span class="s1">&#39;Vertex0&#39;</span><span class="p">,</span> <span class="s1">&#39;Vertex1&#39;</span><span class="p">,</span> <span class="s1">&#39;Vertex2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">self_</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">self_</span><span class="o">.</span><span class="n">__update</span><span class="p">(</span><span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pmToPvFaces</span><span class="p">(</span><span class="n">triangles</span><span class="p">)))</span>
            <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">self_</span><span class="o">.</span><span class="n">triangle_info</span><span class="p">[</span><span class="s1">&#39;GroupID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()]</span>
            <span class="n">self_</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
            <span class="n">self_</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">self_</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ctp</span><span class="p">()</span>  <span class="c1"># triangle data to point data</span>
            <span class="n">self_</span><span class="o">.</span><span class="n">myo</span><span class="p">,</span> <span class="n">self_</span><span class="o">.</span><span class="n">non_myo</span> <span class="o">=</span> <span class="n">self_</span><span class="o">.</span><span class="n">extractMyoAndNonMyo</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">initialiseFromVtkFile</span><span class="p">(</span><span class="n">self_</span><span class="p">,</span> <span class="n">name_</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Initialize a mesh from .vtk file.</span>

<span class="sd">            Args:</span>
<span class="sd">                self_: self_: self, the :class:`CartoMesh` object, passed through from the overarching function.</span>

<span class="sd">                name_: name of .mesh file to be initialised, including &#39;.vtk&#39; extension</span>

<span class="sd">            Returns:</span>
<span class="sd">                None: Nothing. Updates mesh.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">self_</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">self_</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">parseName</span><span class="p">(</span><span class="n">name_</span><span class="p">)</span>
            <span class="n">self_</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">self_</span><span class="o">.</span><span class="n">__update</span><span class="p">(</span><span class="n">pv</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">self_</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">self_</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.vtk&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;.vtk&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">initialiseFromVtkFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">initialiseFromMeshFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__cartoToCsv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads in a carto .mesh file and generates .csv files per header in real-time in the same directory</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose: Use verbose output. Default=True</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Nothing. Writes out .csv files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.mesh&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># variables used throughout loop:</span>
            <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;Header&quot;</span>  <span class="c1"># name of current section</span>
            <span class="n">current_line</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># index of current line being read</span>
            <span class="n">section_line</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># index of current section name</span>
            <span class="n">section_ind</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Section 0 = Header, file format info</span>
            <span class="c1"># Section 1 = General Attributes, info about section data</span>
            <span class="c1"># Section 2 = VerticesSection, x y z coordinates plus data (normals and GroupID)</span>
            <span class="c1"># Section 3 = TrianglesSection,</span>
            <span class="c1"># section 4 = VerticesColorSection</span>
            <span class="c1"># Section 5 = VerticesAttributesSection</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">current_line</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># update line index</span>

                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;[&quot;</span><span class="p">:</span>  <span class="c1"># new section encountered</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">section_ind</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;. &#39;</span> <span class="o">+</span> <span class="n">section</span><span class="p">)</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># section name</span>
                    <span class="n">section_line</span> <span class="o">=</span> <span class="n">current_line</span>
                    <span class="n">section_ind</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># Opening or closing csv files</span>
                    <span class="k">if</span> <span class="n">section_ind</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">of</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># past VerticesSection, an outfile has already been created (infra)</span>
                    <span class="k">if</span> <span class="n">section_ind</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># skip GeneralAttributes</span>
                        <span class="n">of</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">section</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">section_ind</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># useful data</span>
                    <span class="k">if</span> <span class="n">section_ind</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">header_line</span> <span class="o">=</span> <span class="n">section_line</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># VerticesColorSection has extra line</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">header_line</span> <span class="o">=</span> <span class="n">section_line</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">current_line</span> <span class="o">==</span> <span class="n">header_line</span><span class="p">:</span>  <span class="c1"># column names</span>
                        <span class="n">column_names</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># first element is useless &quot;;&quot;</span>
                        <span class="n">of</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Index&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
                            <span class="n">of</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                        <span class="n">of</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;;&quot;</span><span class="p">:</span>  <span class="c1"># actual data, not empty line or column names</span>
                        <span class="n">ind</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>  <span class="c1"># line has shape &quot;ind = x  y  z  nx  ny  nz  groupID</span>
                        <span class="n">of</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>  <span class="c1"># ignore ind</span>
                            <span class="n">of</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">))</span>
                        <span class="n">of</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">of</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__readVertTri</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads VerticesSection.csv and TrianglesSection.csv files and initializes class</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Nothing. Updates mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/VerticesSection.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">))</span> \
               <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/TrianglesSection.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)),</span> \
            <span class="s2">&quot;VerticesSection.csv or TrianglesSection.csv not found! Run cartoToCsv() first.&quot;</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/VerticesSection.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">tri</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/TrianglesSection.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vert</span><span class="p">,</span> <span class="n">tri</span>

    <span class="k">def</span> <span class="nf">__getNeighboringFaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds all mesh facets containing some point.</span>

<span class="sd">        Args:</span>
<span class="sd">            index: the index referring to the mesh point.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame: Pandas DataFrame containing the triangles that have the point at index. The DataFrame</span>
<span class="sd">            contains the following columns: &#39;Vertex0&#39;, &#39;Vertex1&#39;, &#39;Vertex2&#39;, &#39;NormalX&#39;, &#39;NormalY&#39;, &#39;NormalZ&#39;, &#39;GroupID&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">facets_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">triangle_info</span><span class="p">[[</span><span class="s1">&#39;Vertex0&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">triangle_info</span><span class="p">[[</span><span class="s1">&#39;Vertex1&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span> <span class="o">|</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">triangle_info</span><span class="p">[[</span><span class="s1">&#39;Vertex2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">index</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">facets_</span>

    <span class="k">def</span> <span class="nf">__update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh_</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">,</span> <span class="n">pv</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the CartoMesh to match the given mesh.</span>

<span class="sd">        Args:</span>
<span class="sd">            mesh_: A PyVista mesh of the type PolyData or UnstructuredGrid .</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Nothing. Updates the mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">mesh_</span><span class="o">.</span><span class="n">points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="n">mesh_</span><span class="o">.</span><span class="n">extract_all_edges</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mesh_</span><span class="p">)</span> <span class="o">==</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangles</span> <span class="o">=</span> <span class="n">pvToPmCells</span><span class="p">(</span><span class="n">mesh_</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_triangles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">triangles</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">mesh_</span><span class="p">)</span> <span class="o">==</span> <span class="n">pv</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="n">pvToPmCells</span><span class="p">(</span><span class="n">mesh_</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangles</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_triangles</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__readSettings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the settings.ini file and updates the CartoMesh accordingly.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Nothing. Updates the mesh settings attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;settings.ini&quot;</span><span class="p">),</span> <span class="s2">&quot;No settings.ini file found&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">(</span><span class="n">inline_comment_prefixes</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;settings.ini&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">section</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<div class="viewcode-block" id="CartoMesh.writeEndoEpi"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh.writeEndoEpi">[docs]</a>    <span class="k">def</span> <span class="nf">writeEndoEpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thickness</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads in .csv files from carto2csv.py, calculates normals of mesh facets and adds two layers of points</span>
<span class="sd">        along these normals: the epi- and endocardium. Writes out these two layers as .txt files.</span>

<span class="sd">        Args:</span>
<span class="sd">            thickness: the distance between the inner (endo) and outer (epi) layer</span>

<span class="sd">            ratio: the ratio of distances from both layers to the original middle layer. A ratio of .8 will add an outer</span>
<span class="sd">            layer .8*thickness from the middle and an inner layer .2*thickness to the inside. Ratios &gt; .5 are</span>
<span class="sd">            recommended to avoid self intersections.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Nothing. Writes out two files: endo.txt and epi.txt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span> <span class="o">=</span> <span class="n">thickness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="n">ratio</span>
        <span class="n">outside</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">*</span> <span class="n">thickness</span>
        <span class="n">inside</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span> <span class="o">*</span> <span class="n">thickness</span>
        <span class="n">endo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s1">&#39;endo.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
        <span class="n">epi</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s1">&#39;epi.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">endo</span><span class="p">,</span> <span class="n">epi</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s2">&quot;Index,X,Y,Z</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tqbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;        Adding points&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_info</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">tqbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">co</span> <span class="o">=</span> <span class="n">point</span><span class="p">[[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]]</span>
            <span class="n">facets_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getNeighboringFaces</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">av_normal</span> <span class="o">=</span> <span class="n">calcAvNormal</span><span class="p">(</span><span class="n">facets_</span><span class="p">)</span>
            <span class="n">newpoint</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="o">+</span> <span class="n">outside</span> <span class="o">*</span> <span class="n">n</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">av_normal</span><span class="p">)]</span>
            <span class="n">newpoint2</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="n">inside</span> <span class="o">*</span> <span class="n">n</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">av_normal</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="n">endo</span><span class="p">,</span> <span class="n">epi</span><span class="p">),</span> <span class="p">(</span><span class="n">newpoint2</span><span class="p">,</span> <span class="n">newpoint</span><span class="p">)):</span>  <span class="c1"># loop over files and corresponding points</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>  <span class="c1"># components of point</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comp</span> <span class="o">*</span> <span class="mf">1000.</span><span class="p">))</span>  <span class="c1"># Convert from mm to m and write out</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">endo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">epi</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">tqbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="CartoMesh.splitLayer"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh.splitLayer">[docs]</a>    <span class="k">def</span> <span class="nf">splitLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thickness</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">.</span><span class="mi">8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls upon :func:`writeEndoEpi` to write &#39;endo.txt&#39; and &#39;epi.txt&#39;: two files containing the point coordinates of</span>
<span class="sd">        the bounding mesh layers. These are read in again and used to construct two surface meshes. These two</span>
<span class="sd">        surface meshes are added together as one mesh. The class properties are updated to these points and faces.</span>

<span class="sd">        Args:</span>
<span class="sd">            thickness: the distance between the inner (endo) and outer (epi) layer</span>

<span class="sd">            ratio: the ratio of distances from both layers to the original middle layer. A ratio of .8 will add an outer</span>
<span class="sd">            layer .8*thickness from the middle and an inner layer .2*thickness to the inside. Ratios &gt; .5 are</span>
<span class="sd">            recommended to avoid self intersections.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s1">&#39;endo.txt&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s1">&#39;epi.txt&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeEndoEpi</span><span class="p">(</span><span class="n">thickness</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Amount of layers is already &gt;= 2. Splitting aborted.&quot;</span>
        <span class="n">endo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s1">&#39;endo.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">epi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s1">&#39;epi.txt&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">pmToPvFaces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">triangles</span><span class="p">)</span>
        <span class="n">endo</span><span class="p">,</span> <span class="n">epi</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">(</span><span class="n">endo</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">(</span><span class="n">epi</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">endo</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epi</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_info</span><span class="p">[</span><span class="s1">&#39;GroupID&#39;</span><span class="p">]</span>
        <span class="n">fullmesh</span> <span class="o">=</span> <span class="n">endo</span> <span class="o">+</span> <span class="n">epi</span>
        <span class="n">fullmesh</span> <span class="o">=</span> <span class="n">fullmesh</span><span class="o">.</span><span class="n">ctp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">fullmesh</span><span class="o">.</span><span class="n">points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">triangles</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">e</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangles</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">fullmesh</span></div>

<div class="viewcode-block" id="CartoMesh.cleanMesh"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh.cleanMesh">[docs]</a>    <span class="k">def</span> <span class="nf">cleanMesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">print_si</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls upon PyVista&#39;s built-in clean method to clean the mesh. Afterwards, calls upon PyMesh&#39;s</span>
<span class="sd">        built-in methods remove_degenerated_triangles() and detect_self_intersection() to remove</span>
<span class="sd">        duplicated faces and triangles, and resolve self-intersections.</span>

<span class="sd">        Args:</span>
<span class="sd">            tol: tolerance passed to PyVista&#39;s built-in clean() method (absolute tolerance)</span>

<span class="sd">            max_iter: max amount of iterations PyMesh is allowed to try and fix self-intersections,</span>
<span class="sd">            duplicate faces and duplicate vertices.</span>

<span class="sd">            print_si: print the progress of fixing self-intersections</span>

<span class="sd">        Returns:</span>
<span class="sd">            PyVista PolyData: The cleaned mesh</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mesh_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">lines_to_points</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">polys_to_lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">absolute</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mesh_</span> <span class="o">=</span> <span class="n">makePyMesh</span><span class="p">(</span><span class="n">mesh_</span><span class="p">)</span>
        <span class="n">mesh_</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">remove_degenerated_triangles</span><span class="p">(</span><span class="n">mesh_</span><span class="p">)</span>
        <span class="n">si</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">detect_self_intersection</span><span class="p">(</span><span class="n">mesh_</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">print_si</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; self-intersections detected&#39;</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_iter</span> <span class="ow">and</span> <span class="n">si</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># there are still self-intersections, max 10 iterations</span>
            <span class="n">mesh_</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">remove_duplicated_faces</span><span class="p">(</span><span class="n">mesh_</span><span class="p">)</span>
            <span class="n">mesh_</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">remove_duplicated_vertices</span><span class="p">(</span><span class="n">mesh_</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
            <span class="n">mesh_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">resolve_self_intersection</span><span class="p">(</span><span class="n">mesh_</span><span class="p">)</span>
            <span class="n">si</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">detect_self_intersection</span><span class="p">(</span><span class="n">mesh_</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">print_si</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Iteration </span><span class="si">{}</span><span class="s1">: &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; self-intersection(s) left &#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">mesh_</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">remove_duplicated_vertices</span><span class="p">(</span><span class="n">mesh_</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
        <span class="n">mesh_</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">remove_duplicated_faces</span><span class="p">(</span><span class="n">mesh_</span><span class="p">)</span>
        <span class="n">mesh_</span> <span class="o">=</span> <span class="n">makePyVista</span><span class="p">(</span><span class="n">mesh_</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">lines_to_points</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">polys_to_lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">tolerance</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">absolute</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update</span><span class="p">(</span><span class="n">mesh_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>  <span class="c1"># point info does no longer match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triangle_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">mesh_</span></div>

<div class="viewcode-block" id="CartoMesh.getEdgeLengths"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh.getEdgeLengths">[docs]</a>    <span class="k">def</span> <span class="nf">getEdgeLengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pm</span><span class="o">.</span><span class="n">Mesh</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets all edge lengths. If a mesh is given, the mesh must be a PyMesh Mesh object. If no mesh is given (default),</span>
<span class="sd">        the CartoMesh&#39;s mesh attribute is used (PyVista PolyData or UnstructuredGrid)</span>

<span class="sd">        Args:</span>
<span class="sd">            mesh: A PyMesh Mesh object. Default: None</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: An array containing the edge lengths of te mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">extract_all_edges</span><span class="p">()</span> <span class="k">if</span> <span class="n">mesh</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
        <span class="n">pmedges</span> <span class="o">=</span> <span class="n">pvToPmCells</span><span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">extract_cells</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">n_cells</span><span class="p">))</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>  <span class="c1"># extract edge ind as cells</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pmedges</span><span class="p">:</span>
            <span class="n">co1</span><span class="p">,</span> <span class="n">co2</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span>
            <span class="n">distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">co1</span><span class="p">,</span> <span class="n">co2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span></div>

<div class="viewcode-block" id="CartoMesh.homogenizeMesh"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh.homogenizeMesh">[docs]</a>    <span class="k">def</span> <span class="nf">homogenizeMesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">boxplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_dist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">edge_range</span><span class="o">=</span><span class="p">(</span><span class="mf">600.</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iteratively splits long edges and collapses short edges until they all have a length between</span>
<span class="sd">        min_edge and max_edge</span>

<span class="sd">        Args:</span>
<span class="sd">            nsteps: Amount of steps to take to iteratively adapt the mesh edge lengths</span>

<span class="sd">            boxplot: Make a boxplot of the mesh edge lengths for each iteration step after the refinement procedure.</span>

<span class="sd">            return_dist: Return a 2xnsteps array of the mesh edge lengths</span>

<span class="sd">            edge_range: Minimum and maximum allowed edge lengths</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union(PolyData, Tuple[PolyData, List]): Either the refined surface mesh in PyVista&#39;s PolyData format, or both the refined mesh and a list containing all the edge lengths for each iteration step.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">calcAlpha</span><span class="p">(</span><span class="n">n_</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nsteps_</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_edge_</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">longest_edge_</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the longest allowed edge length (alpha) for a given iteration step.</span>
<span class="sd">            Alpha drops exponentially as the iterations progress. At step 0, alpha equals the</span>
<span class="sd">            longest edge of the input mesh. At the final step, alpha equals the maximum desired edge length.</span>

<span class="sd">            Args:</span>
<span class="sd">                n_: Current iteration step</span>

<span class="sd">                nsteps_: Total amount of iteration steps</span>

<span class="sd">                max_edge_: Maximum allowed edge length at final iteration step</span>

<span class="sd">                longest_edge_: The longest edge length of the input mesh before any refinement</span>

<span class="sd">            Returns:</span>
<span class="sd">                float: The longest allowed edge length for the current iteration step</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">n_</span> <span class="o">/</span> <span class="n">nsteps_</span><span class="p">)</span> <span class="o">*</span> <span class="n">longest_edge_</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">n_</span> <span class="o">/</span> <span class="n">nsteps_</span><span class="p">)</span> <span class="o">+</span> <span class="n">max_edge_</span>

        <span class="k">def</span> <span class="nf">calcTol</span><span class="p">(</span><span class="n">n_</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nsteps_</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">min_edge_</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the shortest allowed edge for a given iteration step.</span>
<span class="sd">            The shortest allowed edge augments linearly as the iteration steps progress.</span>

<span class="sd">            Args:</span>
<span class="sd">                n_: Current iteration step</span>

<span class="sd">                nsteps_: Total amount of iteration steps</span>

<span class="sd">                min_edge_: Minimum allowed edge length at the final iteration step.</span>

<span class="sd">            Returns:</span>
<span class="sd">                float: The minimum allowed edge length for the current iteration step.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="mf">500.</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">n_</span> <span class="o">/</span> <span class="n">nsteps_</span><span class="p">)</span> <span class="o">+</span> <span class="n">min_edge_</span>  <span class="c1"># min edge length drops linearly</span>

        <span class="k">def</span> <span class="nf">plotEdgelengths</span><span class="p">(</span><span class="n">dist_range</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Plots a boxplot of the edge lengths at each iteration step</span>
<span class="sd">            dist_range should be a 2D array, each array entry containing all the edge lengths at</span>
<span class="sd">            an iteration step</span>

<span class="sd">            Args:</span>
<span class="sd">                dist_range: An NxM array containing the mesh edge lengths for each iteration step, where M is the amount</span>
<span class="sd">                of mesh edges at iteration step N.</span>

<span class="sd">                show: Show the plot. Default = True</span>

<span class="sd">                save: Save the plot. Default = True</span>

<span class="sd">            Returns:</span>
<span class="sd">                None: Nothing</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;fivethirtyeight&#39;</span><span class="p">)</span>
            <span class="n">medians</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dist_range</span><span class="p">]</span>
            <span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dist_range</span><span class="p">]</span>
            <span class="n">sigmas</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dist_range</span><span class="p">]]</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Edge length (m)&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration step&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">h_pad</span><span class="o">=</span><span class="mf">1.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">((</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">nsteps</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">nsteps</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="n">max_edge</span><span class="p">,</span> <span class="n">max_edge</span><span class="p">,</span> <span class="n">min_edge</span><span class="p">,</span> <span class="n">min_edge</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">alpha</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Desired edgelength</span><span class="se">\n</span><span class="s1">(</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1"> m)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_edge</span><span class="p">,</span> <span class="n">max_edge</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">max_edge</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">min_edge</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
            <span class="n">polygonx</span> <span class="o">=</span> <span class="p">[</span><span class="o">.</span><span class="mi">88</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">nsteps</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">nsteps</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> <span class="p">[</span><span class="o">.</span><span class="mi">88</span><span class="p">]</span>
            <span class="n">polygony</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="o">+</span> <span class="n">s</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">)]</span> <span class="o">+</span> \
                       <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="n">m</span> <span class="o">-</span> <span class="n">s</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">)]))</span>
            <span class="c1"># ax.fill(polygonx, polygony, color=colors[0], alpha=.2, label=&quot;mean $\pm$ $\sigma$&quot;)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">dist_range</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dist_range</span><span class="p">)),</span> <span class="n">whis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
                       <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">),</span>
                       <span class="n">medianprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">),</span>
                       <span class="n">whiskerprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">),</span>
                       <span class="n">capprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsteps</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="n">calcAlpha</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">)</span>  <span class="c1"># xaxis needs to be shifted by one for matplotlib bullshit reasons, hence range(1, nsteps+2)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsteps</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="n">calcTol</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\alpha$ and tolerance&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Mesh edge lengths during refinement&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;../Plots/EdgeLengthRefinement_</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_edge</span><span class="p">,</span> <span class="n">max_edge</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="n">min_edge</span><span class="p">,</span> <span class="n">max_edge</span> <span class="o">=</span> <span class="n">edge_range</span>
        <span class="n">edge_lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEdgeLengths</span><span class="p">()</span>
        <span class="n">longest_edge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">edge_lengths</span><span class="p">)</span>
        <span class="n">mesh_</span> <span class="o">=</span> <span class="n">makePyMesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">boxplot</span><span class="p">:</span>
            <span class="n">dist_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">edge_lengths</span><span class="p">]</span>  <span class="c1"># initialize list of distances during refinement procedure</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;        Resizing edges&#39;</span><span class="p">):</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">calcAlpha</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">max_edge</span><span class="p">,</span> <span class="n">longest_edge</span><span class="p">)</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="n">calcTol</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">min_edge</span><span class="p">)</span>
            <span class="n">splitmesh_</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">split_long_edges</span><span class="p">(</span><span class="n">mesh_</span><span class="p">,</span> <span class="n">max_edge_length</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">colmesh_</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">collapse_short_edges</span><span class="p">(</span><span class="n">splitmesh_</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">preserve_feature</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">colmesh_</span><span class="o">.</span><span class="n">remove_attribute</span><span class="p">(</span><span class="s1">&#39;face_sources&#39;</span><span class="p">)</span>  <span class="c1"># pymesh adds this attribute. Makes conversion difficult.</span>
            <span class="n">mesh_</span> <span class="o">=</span> <span class="n">colmesh_</span>
            <span class="k">if</span> <span class="n">boxplot</span><span class="p">:</span>
                <span class="n">dist_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getEdgeLengths</span><span class="p">(</span><span class="n">mesh_</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">boxplot</span><span class="p">:</span>
            <span class="n">plotEdgelengths</span><span class="p">(</span><span class="n">dist_range</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Cleaning mesh...&quot;</span><span class="p">)</span>
        <span class="n">mesh_</span> <span class="o">=</span> <span class="n">cleanMesh</span><span class="p">(</span><span class="n">makePyVista</span><span class="p">(</span><span class="n">mesh_</span><span class="p">),</span> <span class="n">tol</span><span class="o">=</span><span class="n">min_edge</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update</span><span class="p">(</span><span class="n">mesh_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">min_edge</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_edge</span><span class="p">))</span>  <span class="c1"># update name</span>

        <span class="k">if</span> <span class="n">return_dist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mesh_</span><span class="p">,</span> <span class="n">getEdgeLengths</span><span class="p">(</span><span class="n">makePyMesh</span><span class="p">(</span><span class="n">mesh_</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mesh_</span>  <span class="c1"># return final version of mesh</span></div>

<div class="viewcode-block" id="CartoMesh.tetrahedralise"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh.tetrahedralise">[docs]</a>    <span class="k">def</span> <span class="nf">tetrahedralise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">switches</span><span class="p">,</span> <span class="n">n_col_retry</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs TetGen as a bash command.</span>

<span class="sd">        Args:</span>
<span class="sd">            switches: Switches to use with the TetGen command. See https://www.wias-berlin.de/software/tetgen/switches.html</span>

<span class="sd">            n_col_retry: Amount of times to attempt to fix collinearities during the TetGen process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Nothing. Writes out a .vtk file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">runTetGen</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">switches_</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Runs TetGen in terminal and captures output.</span>

<span class="sd">            Args:</span>
<span class="sd">                name: name of the base file</span>

<span class="sd">                switches_: Switches to be used together with TetGen bash command.</span>

<span class="sd">            Returns:</span>
<span class="sd">                [[int, int]]: A list containing pairs of indices. These pairs define a mesh segment that&#39;s colinear.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
            <span class="n">tetcommand</span> <span class="o">=</span> <span class="s2">&quot;tetgen </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">.smesh&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">switches_</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;stdbuf&#39;</span><span class="p">,</span> <span class="s1">&#39;-o0&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">tetcommand</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Now running bash command </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">-------------------- TetGen output --------------------&quot;</span><span class="p">)</span>
            <span class="c1"># adding stdbuf -o0 makes TetGen output real-time</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">colin_pair</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                <span class="n">l_</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">l_</span><span class="p">)</span>
                <span class="c1"># The following checks assume that, if an error is found, it&#39;s colinearity</span>
                <span class="c1"># This still needs to be expanded for overlapping lines and segments intersecting triangles</span>
                <span class="k">if</span> <span class="s1">&#39;1st&#39;</span> <span class="ow">in</span> <span class="n">l_</span> <span class="ow">and</span> <span class="s1">&#39;facet&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_</span> <span class="ow">and</span> <span class="s1">&#39;seg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_</span><span class="p">:</span>
                    <span class="c1"># line is of form &quot;1st: [24578,24581].&quot;</span>
                    <span class="c1"># split at &quot;:&quot;, drop first two (whitespace and &quot;[&quot;) and last two (&quot;]&quot; and &quot;.&quot;) chars</span>
                    <span class="c1"># split at comma to make list again</span>
                    <span class="n">edge1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l_</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="s1">&#39;2nd&#39;</span> <span class="ow">in</span> <span class="n">l_</span> <span class="ow">and</span> <span class="s1">&#39;facet&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_</span> <span class="ow">and</span> <span class="s1">&#39;seg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_</span><span class="p">:</span>
                    <span class="c1"># line is of form &quot;2nd: [24578,24581].&quot;</span>
                    <span class="n">edge2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l_</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                    <span class="n">colin_pair</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">edge1</span><span class="p">,</span> <span class="n">edge2</span><span class="p">])</span>
                <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">------------------ End TetGen output ------------------&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">colin_pair</span>

        <span class="n">colinear_pairs</span> <span class="o">=</span> <span class="n">runTetGen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">switches</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_col_retry</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">colinear_pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># check for collinear pairs</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Collinearity found! Adapting points...&quot;</span><span class="p">)</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">makeNonCollinear</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">colinear_pairs</span><span class="p">)</span>
            <span class="n">writeToSmesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">colinear_pairs</span> <span class="o">=</span> <span class="n">runTetGen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">switches</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="CartoMesh.extractMyoAndNonMyo"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh.extractMyoAndNonMyo">[docs]</a>    <span class="k">def</span> <span class="nf">extractMyoAndNonMyo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">,</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks scalar data of the mesh in its current state (clinical tags) and extracts the part of the mesh with</span>
<span class="sd">        tags that correspond to myocardium (tag == 0).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[pv.PolyData, pv.PolyData]: A tuple containing two PyVista PolyData meshes: a pointcloud of points</span>
<span class="sd">            corresponding to the mesh myocardium and a pointcloud of the rest of the mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">myo</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">()</span>
        <span class="n">noncond</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]):</span>
            <span class="n">tagged_pointcloud</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">points</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tag</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">myo</span> <span class="o">+=</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">(</span><span class="n">tagged_pointcloud</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">noncond</span> <span class="o">+=</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">(</span><span class="n">tagged_pointcloud</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">myo</span><span class="p">,</span> <span class="n">noncond</span></div>

<div class="viewcode-block" id="CartoMesh.writeTags"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh.writeTags">[docs]</a>    <span class="k">def</span> <span class="nf">writeTags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes out all points in a mesh with a certain tag to a .csv file</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Nothing. Writes out .csv files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">tagged_pointcloud</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">points</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tag</span><span class="p">]]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s2">&quot;Tag_</span><span class="si">{}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
                <span class="n">csvWriter</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">csvWriter</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">tagged_pointcloud</span><span class="p">)</span></div>

<div class="viewcode-block" id="CartoMesh.writeAdjustNa2"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh.writeAdjustNa2">[docs]</a>    <span class="k">def</span> <span class="nf">writeAdjustNa2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">g_Na</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">7.8</span><span class="p">,</span> <span class="n">write_dat</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes adjustment file to close off Na2+ channels in cells where CV ~ 0</span>

<span class="sd">        Args:</span>
<span class="sd">            tol: tolerance for when a point is considered to have a conduction velocity of 0. Points whose</span>
<span class="sd">            conduction velocity &lt; tol are considered to be zero.</span>

<span class="sd">            g_Na: value for (maximum) Sodium channel conductance. Open Na-channels are set to this conductance.</span>
<span class="sd">            Default: 7.8 pS</span>

<span class="sd">            write_dat: write a .dat file for visual inspection in e.g. meshalyzer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Nothing. Writes out a .txt file and, if wanted, a .dat file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">writeDat</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mesh</span><span class="p">:</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gNA2&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Write a .dat file. This file is a column of 0s and 1s. The index column corresponds to the mesh point index.</span>
<span class="sd">            If the value equals to one on row i, then mesh.points[i] is a point whose Na2+ channel has been closed off.</span>

<span class="sd">            Args:</span>
<span class="sd">                d: Directory to write .dat file to</span>

<span class="sd">                mesh: A Pyvista PolyData mesh</span>

<span class="sd">                name: Name of the .dat file, without file extension. Default = &#39;gNA2&#39;</span>

<span class="sd">            Returns:</span>
<span class="sd">                None: Nothing. Writes out .dat file &lt;name&gt;.dat</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">datfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_points</span><span class="p">)</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">ptn</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">:</span>
                <span class="n">datfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">datfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_cells</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_triangles</span><span class="p">,</span> <span class="s2">&quot;Mesh does not contain any cells or triangles.&quot;</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">pvToPmCells</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span> <span class="k">else</span> <span class="n">pvToPmCells</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">triangles</span><span class="p">)</span>
        <span class="n">speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span>

        <span class="n">ptn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">points</span><span class="p">))</span> <span class="o">*</span> <span class="n">g_Na</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">speed</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">speed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>  <span class="c1"># if CV is ~ 0 -&gt; close off Na channel</span>
                <span class="n">vertices</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">ptn</span><span class="p">[</span><span class="n">vertices</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">stimfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s2">&quot;gNA2.adj&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
        <span class="n">stimfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ptn</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;extra</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ptn</span><span class="p">)):</span>
            <span class="n">stimfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">stimfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">write_dat</span><span class="p">:</span>
            <span class="n">writeDat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;gNA2&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CartoMesh.setNonCondByIndexFiles"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh.setNonCondByIndexFiles">[docs]</a>    <span class="k">def</span> <span class="nf">setNonCondByIndexFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_dir</span><span class="o">=</span><span class="s1">&#39;Regions&#39;</span><span class="p">,</span> <span class="n">write_dat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s2">&quot;meshID&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Opens directory region_dir and reads in .csv files there. These .csv files should contain the indices of</span>
<span class="sd">        points whose conduction velocity should be set to zero.</span>
<span class="sd">        Writes out a .dat file for each .csv file if wanted</span>

<span class="sd">        Args:</span>
<span class="sd">            region_dir: Name of directory containing the regions to be set to a conduction velocity of 0.</span>
<span class="sd">            These regions should be .csv files containing the indices of points to be set to CV=0</span>

<span class="sd">            index_col: Name of the column in the .csv files that contain the point indices.</span>
<span class="sd">            Default=\&quot;meshID\&quot; for easy workflow in correspondence with :func:`mesh_tools.ptsToParaview`</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">writeDat</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">n_points</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Writes a .dat file for a given pd.DataFrame&quot;&quot;&quot;</span>
            <span class="c1"># write scar .dat file</span>
            <span class="n">datfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;meshID&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">:</span>
                <span class="n">datfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">datfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">getNonCondRegions</span><span class="p">(</span><span class="n">meshdir</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">region_dir_</span><span class="o">=</span><span class="n">region_dir</span><span class="p">,</span> <span class="n">write_dat_</span><span class="o">=</span><span class="n">write_dat</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
            <span class="n">non_cond_region_indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">meshdir</span> <span class="o">+</span> <span class="n">region_dir_</span><span class="p">):</span>  <span class="c1"># apply scars if directory exists</span>
                <span class="k">for</span> <span class="n">csvfile</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">meshdir</span> <span class="o">+</span> <span class="n">region_dir_</span> <span class="o">+</span> <span class="s2">&quot;/*.csv&quot;</span><span class="p">):</span>
                    <span class="n">scar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">write_dat_</span><span class="p">:</span>
                        <span class="n">writeDat</span><span class="p">(</span><span class="n">scar</span><span class="p">,</span> <span class="n">csvfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">points</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">scar</span><span class="p">[</span><span class="n">index_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                        <span class="n">non_cond_region_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">non_cond_region_indices</span><span class="p">)</span>

        <span class="c1"># Set manually selected scars to 0 velocity</span>
        <span class="n">scars</span> <span class="o">=</span> <span class="n">getNonCondRegions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;Regions&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">scars</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">][</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_points</span><span class="p">)]</span></div>

<div class="viewcode-block" id="CartoMesh.applyCV"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh.applyCV">[docs]</a>    <span class="k">def</span> <span class="nf">applyCV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speed_file</span><span class="o">=</span><span class="s1">&#39;speed.csv&#39;</span><span class="p">,</span>
                <span class="n">write_csv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write_VTK_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write_txt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">write_dat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write_xyz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;scale_factors/&#39;</span><span class="p">,</span> <span class="n">region_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ncv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">speed_col</span><span class="o">=</span><span class="s2">&quot;speed&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies conduction velocities on a reconstructed tetrahedralised carto mesh.</span>

<span class="sd">        Args:</span>
<span class="sd">            speed_file: Name of the file containing the coordinates and conduction velocity values to interpolate.</span>

<span class="sd">            write_csv: Write out the coordinates and speeds to a .csv file</span>

<span class="sd">            write_VTK_file: Write out the resulting mesh to .vtk</span>

<span class="sd">            write_txt: Write out the conduction velocities as scale factors (readable by OpenCARP) to &lt;outdir&gt;</span>

<span class="sd">            write_dat: Write out the regions of the mesh with CV=0 to .dat file, to visualize in Meshalyzer</span>
<span class="sd">            write_xyz: Write point cloud of the conduction velocites, as interpolated on the mesh</span>
<span class="sd">            outdir: Name of the directory to contain the scale factors aka conduction velocities</span>
<span class="sd">            region_dir: Name of the directory containing .csv files with indices of mesh points whose conduction velocity will be set to 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Nothing. Writes out one or more of the following files in &lt;outdir&gt;: .csv, .vtk, .txt, .dat or a</span>
<span class="sd">            pointcloud .csv file if &lt;write_xyz&gt; == True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">applySpeedLimit</span><span class="p">(</span><span class="n">data_</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">speed_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;speed&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Given a DataFrame, cuts off all conduction velocities whose conduction velocity in the column &lt;speed_col&gt;</span>
<span class="sd">            have a value outside the range of &lt;limit&gt;</span>
<span class="sd">            Args:</span>
<span class="sd">                data_: The DataFrame containing the conduction velocities</span>
<span class="sd">                limit: The minimum and maximum allowed conduction velocities as a tuple with length 2</span>
<span class="sd">                speed_col: Name of the DataFrame column containing the conduction velocities. Default = &#39;speed&#39;</span>

<span class="sd">            Returns:</span>
<span class="sd">                DataFrame: DataFrame whose conduction velocities in the column &lt;speed_col&gt; have been cut off to match &lt;speed_col&gt;</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">speeds</span> <span class="o">=</span> <span class="n">data_</span><span class="p">[</span><span class="n">speed_col</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">speeds</span><span class="p">)):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">speeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">speeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">speeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">data_</span><span class="p">[</span><span class="n">speed_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">speeds</span>
            <span class="k">return</span> <span class="n">data_</span>

        <span class="k">def</span> <span class="nf">randomizeCV</span><span class="p">(</span><span class="n">data_</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">speed_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;speed&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Given a mesh with conduction velocities, makes a variation on this conduction velocity distribution.</span>
<span class="sd">            A normal distribution is fitted to each point and their neighbors. From this distribution, a new</span>
<span class="sd">            conduction velocity is randomly sampled.</span>
<span class="sd">            Args:</span>
<span class="sd">                data_: the mesh in pd.DataFrame format. Must contain columns &#39;x&#39;, &#39;y&#39; and &#39;z&#39; with the coordinates in m.</span>
<span class="sd">                n_neighbors: amount of neighbors to use for each normal distribution fitting.</span>
<span class="sd">                speed_col: name of the column containing the conduction velocity values for each mesh point.</span>
<span class="sd">            Returns:</span>
<span class="sd">                DataFrame: DataFrame containing the original point coordinates and updated conduction velocities&quot;&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">#### Variation &quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="c1"># tweak conduction velocities of input CV file</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">data_</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
            <span class="n">speeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;        Calculating new velocities&#39;</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">dist</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">p</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">)</span>
                <span class="n">neighborCVs</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">[</span><span class="mi">0</span><span class="p">]]][</span><span class="n">speed_col</span><span class="p">]</span>
                <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">neighborCVs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">neighborCVs</span><span class="p">)</span>
                <span class="n">new_cv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">speeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">new_cv</span><span class="p">)</span>
            <span class="n">data_</span><span class="p">[</span><span class="n">speed_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">speeds</span>
            <span class="k">return</span> <span class="n">data_</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ncv</span><span class="p">:</span>
            <span class="n">n_cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;reconstruction_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;n_cv&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_cv</span> <span class="o">=</span> <span class="n">ncv</span>

        <span class="c1"># read in data</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">speed_file</span><span class="p">,</span>
                                 <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">])</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">applySpeedLimit</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cv_interpolation_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;speed_limit&#39;</span><span class="p">])</span>
        <span class="n">med_speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">])</span>
        <span class="c1"># create new dataframe for mutable purposes</span>
        <span class="n">calculated_data</span> <span class="o">=</span> <span class="n">input_data</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cv</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># variations of conduction velocities</span>
                <span class="n">calculated_data</span> <span class="o">=</span> <span class="n">randomizeCV</span><span class="p">(</span><span class="n">calculated_data</span><span class="p">,</span>
                                              <span class="n">n_neighbors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cv_interpolation_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;n_neighbors&#39;</span><span class="p">])</span>

            <span class="c1"># Create PolyData to use in interpolation</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">applySpeedLimit</span><span class="p">(</span><span class="n">calculated_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cv_interpolation_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;speed_limit&#39;</span><span class="p">])</span>
            <span class="n">pvdata</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">PolyData</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">pvdata</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span>

            <span class="c1"># Interpolate on mesh</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Interpolating on mesh&quot;</span><span class="p">)</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">pvdata</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cv_interpolation_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span>
                                         <span class="n">sharpness</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cv_interpolation_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;sharpness&#39;</span><span class="p">],</span>
                                         <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;null_value&quot;</span><span class="p">,</span> <span class="n">null_value</span><span class="o">=</span><span class="n">med_speed</span><span class="p">,</span>
                                         <span class="n">pass_cell_arrays</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__update</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>  <span class="c1"># set mesh</span>
            <span class="k">if</span> <span class="n">region_dir</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Setting regions to 0 conduction velocity&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setNonCondByIndexFiles</span><span class="p">(</span><span class="n">region_dir</span><span class="p">,</span> <span class="n">write_dat</span><span class="p">)</span>

            <span class="n">pointdata</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">ptc</span><span class="p">()</span>  <span class="c1"># point data to cell data</span>
            <span class="n">cell_data</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span>
            <span class="n">sq_point_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">e</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">pointdata</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;squared speed&quot;</span><span class="p">])</span>
            <span class="n">sq_cell_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">e</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cell_data</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;squared speed&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__update</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">outdir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">outdir</span><span class="p">)</span>
            <span class="c1"># write to csv file</span>
            <span class="k">if</span> <span class="n">write_csv</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Writing squared speed to csv&quot;</span><span class="p">)</span>
                <span class="n">sq_point_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;sq_CV_point_</span><span class="si">{}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">index_label</span><span class="o">=</span><span class="s2">&quot;PointID&quot;</span><span class="p">)</span>
                <span class="n">sq_cell_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;sq_CV_cell_</span><span class="si">{}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">index_label</span><span class="o">=</span><span class="s2">&quot;CellID&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">write_xyz</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Writing point cloud&quot;</span><span class="p">)</span>
                <span class="n">of</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;input_points_</span><span class="si">{}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
                <span class="n">of</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;X,Y,Z,speed</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pvdata</span><span class="o">.</span><span class="n">points</span><span class="p">))):</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">pvdata</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">pvdata</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                        <span class="n">of</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="n">of</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">of</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># write text file to read in during simulation</span>
            <span class="k">if</span> <span class="n">write_txt</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Writing txt file: </span><span class="si">{}</span><span class="s2">scale_factor_</span><span class="si">{}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                <span class="n">of</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;scale_factor_</span><span class="si">{}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">sq_cell_data</span><span class="p">[</span><span class="s2">&quot;squared speed&quot;</span><span class="p">]:</span>
                    <span class="n">of</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">of</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># .dat file for visualisation purposes</span>
            <span class="k">if</span> <span class="n">write_dat</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Writing dat file: </span><span class="si">{}</span><span class="s2">scale_factor_</span><span class="si">{}</span><span class="s2">.dat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                <span class="n">of</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;scale_factor_</span><span class="si">{}</span><span class="s2">.dat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">sq_point_data</span><span class="p">[</span><span class="s2">&quot;squared speed&quot;</span><span class="p">]:</span>
                    <span class="n">of</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">of</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># write to vtk for inspection in paraview</span>
            <span class="k">if</span> <span class="n">write_VTK_file</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Writing mesh to </span><span class="si">{}{}</span><span class="s2">_CV</span><span class="si">{}</span><span class="s2">.vtk&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                <span class="n">pv</span><span class="o">.</span><span class="n">save_meshio</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_CV</span><span class="si">{}</span><span class="s2">.vtk&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span></div>

<div class="viewcode-block" id="CartoMesh.reconstruct"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh.reconstruct">[docs]</a>    <span class="k">def</span> <span class="nf">reconstruct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads in .mesh file and writes out a refined tetrahedron mesh in .vtk format and carp format.</span>
<span class="sd">        If &#39;speed.csv&#39; exists in the cwd, also interpolates these speeds on the mesh. speed.csv should be a csv file with</span>
<span class="sd">        columns &#39;x&#39;, &#39;y&#39;, &#39;z&#39; and &#39;speed&#39;, where the xyz coordinates refer to point coordinates. Can be calculated with</span>
<span class="sd">        DGM.</span>

<span class="sd">        Args:</span>

<span class="sd">        Returns:</span>
<span class="sd">          Nothing.</span>
<span class="sd">          Writes out a .vtk file of the tetrahedron mesh. Writes out the same mesh in Carp text format.</span>
<span class="sd">          Updates the mesh to the tetrahedron mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">getPipeline</span><span class="p">(</span><span class="n">self_</span><span class="p">,</span> <span class="n">boxplot</span><span class="p">,</span> <span class="n">switches</span><span class="p">,</span> <span class="n">refine_steps</span><span class="p">,</span> <span class="n">min_edge</span><span class="p">,</span> <span class="n">max_edge</span><span class="p">,</span> <span class="n">n_cv</span><span class="p">,</span> <span class="n">n_col_retry</span><span class="p">,</span> <span class="n">keep_intmed</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Given a set of parameters, generate the functions with corresponding parameters to reconstruct</span>
<span class="sd">            a carto mesh from zero to simulation-ready.</span>
<span class="sd">            Args:</span>
<span class="sd">                self_: self</span>
<span class="sd">                boxplot: bool: Whether or not to make a boxplot of the edgelengths during refinement in :func:`homogenizeMesh`</span>
<span class="sd">                switches: str: The switches used in the tetgen command</span>
<span class="sd">                refine_steps: int: amount of refinement steps during :func:`homogenizeMesh`</span>
<span class="sd">                min_edge: float: Minimum allowed edge length</span>
<span class="sd">                max_edge: float: Maximum allowed edge length</span>
<span class="sd">                n_cv: int: Amount of conduction velocity distribution files to make.</span>
<span class="sd">                n_col_retry: int: Amount of times you want to try to fix colinearities during TetGen command.</span>
<span class="sd">                keep_intmed: bool: Unused. For completeness.&quot;&quot;&quot;</span>
            <span class="n">pipeline_</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Adding endo and epi point layers&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">self_</span><span class="o">.</span><span class="n">splitLayer</span><span class="p">],</span>
                     <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[{}]}</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Refining surface mesh&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">self_</span><span class="o">.</span><span class="n">homogenizeMesh</span><span class="p">],</span>
                     <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;nsteps&#39;</span><span class="p">:</span> <span class="n">refine_steps</span><span class="p">,</span> <span class="s1">&#39;boxplot&#39;</span><span class="p">:</span> <span class="n">boxplot</span><span class="p">,</span> <span class="s1">&#39;edge_range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">min_edge</span><span class="p">,</span> <span class="n">max_edge</span><span class="p">)}]}</span>

                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Writing to .smesh&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">writeToSmesh</span><span class="p">],</span>
                     <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;mesh&#39;</span><span class="p">:</span> <span class="n">self_</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">self_</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">self_</span><span class="o">.</span><span class="n">name</span><span class="p">}]}</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Tetrahedralising with TetGen&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">self_</span><span class="o">.</span><span class="n">tetrahedralise</span><span class="p">],</span>
                     <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;switches&#39;</span><span class="p">:</span> <span class="n">switches</span><span class="p">,</span> <span class="s1">&#39;n_col_retry&#39;</span><span class="p">:</span> <span class="n">n_col_retry</span><span class="p">}]}</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Converting to carp and paraview-friendly format&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">convertMesh_Meshtool</span><span class="p">,</span> <span class="n">ptsToParaview</span><span class="p">],</span>
                     <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;meshname&#39;</span><span class="p">:</span> <span class="n">self_</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">self_</span><span class="o">.</span><span class="n">name</span><span class="p">},</span>
                              <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">self_</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">self_</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.pts&#39;</span><span class="p">,</span> <span class="s1">&#39;column_name&#39;</span><span class="p">:</span> <span class="s1">&#39;meshID&#39;</span><span class="p">}]}</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Cleaning with meshtool&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cleanMesh_Meshtool</span><span class="p">,</span> <span class="n">convertMesh_Meshtool</span><span class="p">],</span>
                     <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;meshname&#39;</span><span class="p">:</span> <span class="n">self_</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">self_</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="o">.</span><span class="mi">2</span><span class="p">},</span>
                              <span class="p">{</span><span class="s1">&#39;meshname&#39;</span><span class="p">:</span> <span class="n">self_</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">self_</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ifmt&#39;</span><span class="p">:</span> <span class="s1">&#39;carp_txt&#39;</span><span class="p">,</span> <span class="s1">&#39;ofmt&#39;</span><span class="p">:</span> <span class="s1">&#39;vtk&#39;</span><span class="p">}]}</span>
                <span class="p">)</span>
            <span class="p">])</span>
            <span class="k">if</span> <span class="n">n_cv</span><span class="p">:</span>
                <span class="n">pipeline_</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;Applying conduction velocities&quot;</span><span class="p">:</span>
                                      <span class="p">{</span><span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">applyCV</span><span class="p">],</span>
                                       <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;write_VTK_file&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}]</span>
                                       <span class="p">}</span>
                                  <span class="p">})</span>
            <span class="k">return</span> <span class="n">pipeline_</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">####### Creating 3D tetrahedralized </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">getPipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;reconstruction_parameters&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">action_name</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---- </span><span class="si">{}</span><span class="s2">. </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">action_name</span><span class="p">))</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">[</span><span class="n">action_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">],</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]):</span>
                <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="c1"># Reinitialise pipeline dict to update function arguments</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">getPipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;reconstruction_parameters&#39;</span><span class="p">])</span>
            <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;reconstruction_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;keep_intmed&#39;</span><span class="p">]:</span>  <span class="c1"># delete intermediate files</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">----- </span><span class="si">{}</span><span class="s2">. Deleting intermediate files</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">))</span>
            <span class="c1"># remove intermediate files that weren&#39;t present before generating and aren&#39;t the .vtk file</span>
            <span class="n">to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mid.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;endo.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;epi.txt&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;TrianglesSection.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;VerticesSection.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;VerticesAttributesSection.csv&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;VerticesColorsSection.csv&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.smesh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.1.mtr&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.1.mtr&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.1.p2t&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.1.node&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.1.edge&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.1.face&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.1.ele&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;myo.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;noncond.csv&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">trash</span> <span class="ow">in</span> <span class="n">to_delete</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">trash</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">trash</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Deleted &quot;</span><span class="p">,</span> <span class="n">trash</span><span class="p">)</span>
            <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Mesh reconstructed in </span><span class="si">{0}</span><span class="s2">m </span><span class="si">{1:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">duration</span> <span class="o">//</span> <span class="mi">60</span><span class="p">),</span> <span class="n">duration</span> <span class="o">%</span> <span class="mi">60</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update</span><span class="p">(</span><span class="n">pv</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.1.vtk&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="CartoMesh.plot"><a class="viewcode-back" href="../source/carto_mesh.html#carto_mesh.CartoMesh.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the mesh in its current state using PyVista&#39;s Plotter() method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Nothing. Opens a VtkRenderer window to show the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>
</pre></div>

        </div>
      </div>

      <div id="side-menu-container">

        <div id="search" role="search">
        <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
            <input type="text" name="q" placeholder="Search..." />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>
</div>

        <div id="side-menu" role="navigation">

          
  
    
  
  
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../generated/carto_mesh.html">carto_mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../generated/mesh_tools.html">mesh_tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../generated/reconstruct.html">reconstruct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../generated/apply_cv.html">apply_cv</a></li>
</ul>

  


        </div>

        

      </div>

    </div>

<footer>
    <div id="footer-info">
        <ul id="build-details">
            

            

            
        </ul>

        
            <div id="copyright">
                &copy; 2021, Bjorge Meulemeester
            </div>
        

        <div id="credit">
            created with <a href="http://sphinx-doc.org/">Sphinx</a> and <a href="https://github.com/Autophagy/insegel">Insegel</a>

        </div>
    </div>

    <a id="menu-toggle" class="fa fa-bars" aria-hidden="true"></a>

    <script type="text/javascript">
      $("#menu-toggle").click(function() {
        $("#menu-toggle").toggleClass("toggled");
        $("#side-menu-container").slideToggle(300);
      });
    </script>

</footer> 

</div>

</body>
</html>